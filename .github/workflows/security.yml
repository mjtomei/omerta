name: Security Checks

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  hook-tests:
    name: Git Hook Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Clone sub-repos
        run: |
          for mod in omerta_infra omerta_lang omerta_protocol omerta_node omerta_mesh; do
            git clone --depth=1 "https://github.com/mjtomei/$mod" "${mod}.tmp"
            cp "${mod}/.commit" "${mod}.tmp/.commit" 2>/dev/null || true

            rm -rf "$mod"
            mv "${mod}.tmp" "$mod"
          done

      - name: Ensure hooks are executable
        run: |
          chmod +x .githooks/* 2>/dev/null || true
          for dir in omerta_infra omerta_lang omerta_mesh omerta_node omerta_protocol; do
            [ -d "$dir/.githooks" ] && chmod +x "$dir/.githooks/"* 2>/dev/null || true
          done

      - name: Test hook functionality
        run: ./scripts/test-hooks.sh

  hooks-sync:
    name: Hooks Sync Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Clone sub-repos
        run: |
          for mod in omerta_infra omerta_lang omerta_protocol omerta_node omerta_mesh; do
            git clone --depth=1 "https://github.com/mjtomei/$mod" "${mod}.tmp"
            cp "${mod}/.commit" "${mod}.tmp/.commit" 2>/dev/null || true

            rm -rf "$mod"
            mv "${mod}.tmp" "$mod"
          done

      - name: Verify hooks are in sync
        run: ./scripts/check-hooks-sync.sh

  commit-hash-check:
    name: Verify Commit Hashes
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check .commit files match remote master
        run: |
          FAILED=0
          for mod in omerta_node omerta_mesh omerta_lang omerta_protocol omerta_infra; do
            remote_sha=$(git ls-remote "https://github.com/mjtomei/$mod" refs/heads/master | cut -f1)
            local_sha=$(cat "$mod/.commit" 2>/dev/null | tr -d '[:space:]')

            if [ -z "$remote_sha" ]; then
              echo "WARNING: could not resolve master for $mod"
              continue
            fi

            if [ "$remote_sha" != "$local_sha" ]; then
              echo "::error::$mod/.commit is stale: have ${local_sha:0:8}, want ${remote_sha:0:8}"
              FAILED=1
            else
              echo "OK: $mod (${local_sha:0:8})"
            fi
          done

          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "Run 'make update' to refresh .commit hashes"
            exit 1
          fi

          echo "All .commit hashes are current"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Clone sub-repos
        run: |
          for mod in omerta_infra omerta_lang omerta_protocol omerta_node omerta_mesh; do
            git clone --depth=1 "https://github.com/mjtomei/$mod" "${mod}.tmp"
            cp "${mod}/.commit" "${mod}.tmp/.commit" 2>/dev/null || true

            rm -rf "$mod"
            mv "${mod}.tmp" "$mod"
          done

      - name: Check for sensitive data patterns
        run: |
          FOUND=0

          # --- Private key content patterns ---
          KEY_PATTERNS=(
            '-----BEGIN RSA PRIVATE KEY-----'
            '-----BEGIN DSA PRIVATE KEY-----'
            '-----BEGIN EC PRIVATE KEY-----'
            '-----BEGIN OPENSSH PRIVATE KEY-----'
            '-----BEGIN PGP PRIVATE KEY-----'
          )

          # --- Credential assignment patterns ---
          CREDENTIAL_PATTERNS=(
            'password\s*[:=]\s*["'"'"'][^"'"'"']+'
            'api[_-]?key\s*[:=]\s*["'"'"'][^"'"'"']+'
            'secret[_-]?key\s*[:=]\s*["'"'"'][^"'"'"']+'
          )

          # --- Cloud & service provider keys ---
          SERVICE_PATTERNS=(
            'AWS_ACCESS_KEY_ID\s*[:=]'
            'AWS_SECRET_ACCESS_KEY\s*[:=]'
            'ANTHROPIC_API_KEY\s*[:=]'
            'OPENAI_API_KEY\s*[:=]'
          )

          # --- Token patterns ---
          TOKEN_PATTERNS=(
            'ghp_[A-Za-z0-9]{36}'
            'gho_[A-Za-z0-9]{36}'
            'ghu_[A-Za-z0-9]{36}'
            'ghs_[A-Za-z0-9]{36}'
            'ghr_[A-Za-z0-9]{36}'
            'sk_live_[A-Za-z0-9]+'
            'rk_live_[A-Za-z0-9]+'
            'xox[baprs]-[A-Za-z0-9-]+'
            'SG\.[a-zA-Z0-9_-]{22}\.[a-zA-Z0-9_-]{43}'
            'npm_[A-Za-z0-9]{36}'
            'pypi-[A-Za-z0-9_-]+'
          )

          # --- URL credentials and bearer tokens ---
          URL_PATTERNS=(
            '://[^/:]+:[^@]+@'
            '[Bb]earer\s+[A-Za-z0-9_-]{20,}'
          )

          ALL_PATTERNS=("${KEY_PATTERNS[@]}" "${CREDENTIAL_PATTERNS[@]}" "${SERVICE_PATTERNS[@]}" "${TOKEN_PATTERNS[@]}" "${URL_PATTERNS[@]}")

          EXCLUDE='\.git/|\.venv/|__pycache__/|node_modules/|\.build/|\.githooks/|scripts/test-hooks\.sh|\.github/workflows/security\.yml|omerta_infra/\.env\.example'

          for pattern in "${ALL_PATTERNS[@]}"; do
            MATCHES=$(grep -rniE "$pattern" \
                --include="*.swift" --include="*.py" --include="*.json" \
                --include="*.yaml" --include="*.yml" --include="*.toml" \
                --include="*.sh" --include="*.md" --include="*.txt" \
                --include="*.cfg" --include="*.ini" --include="*.conf" \
                --include="*.env*" --include="*.xml" --include="*.plist" \
                . 2>/dev/null | grep -vE "$EXCLUDE" | grep -vE '/[Tt]ests?/' || true)

            if [ -n "$MATCHES" ]; then
              echo "::error::Sensitive pattern found: $pattern"
              echo "$MATCHES" | head -5
              echo ""
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "::error::Potential sensitive data found in repository"
            exit 1
          fi

          echo "No sensitive data patterns found"

      - name: Check for .env files
        run: |
          ENV_FILES=$(find . -type f \( \
            -name ".env" -o \
            -name ".env.local" -o \
            -name ".env.production" -o \
            -name ".env.development" -o \
            -name ".env.staging" \
            \) -not -path "./.git/*" 2>/dev/null)

          if [ -n "$ENV_FILES" ]; then
            echo "::error::.env files found in repository:"
            echo "$ENV_FILES"
            exit 1
          fi

          echo "No .env files found"

      - name: Check for private key files
        run: |
          KEY_FILES=$(find . -type f \( \
            -name "*.pem" -o \
            -name "*.key" -o \
            -name "*.p12" -o \
            -name "*.pfx" -o \
            -name "*.keystore" -o \
            -name "*.jks" -o \
            -name "id_rsa" -o \
            -name "id_dsa" -o \
            -name "id_ecdsa" -o \
            -name "id_ed25519" -o \
            -name "*service?account*.json" -o \
            -name "token.json" -o \
            -name "credentials.json" -o \
            -name "secrets.json" \
            \) -not -path "./.git/*" 2>/dev/null)

          if [ -n "$KEY_FILES" ]; then
            echo "::error::Private key or credential files found:"
            echo "$KEY_FILES"
            exit 1
          fi

          echo "No private key files found"

      - name: Check for large files
        run: |
          LARGE_FILES=$(find . -type f -size +1M \
            -not -path "./.git/*" \
            -not -path "./.venv/*" \
            -not -path "./.build/*" \
            -not -path "./node_modules/*" \
            -not -name "*.a" \
            -not -name "*.o" \
            -not -name "*.so" \
            -not -name "*.dylib" 2>/dev/null)

          if [ -n "$LARGE_FILES" ]; then
            echo "::error::Large files (>1MB) found:"
            echo "$LARGE_FILES"
            exit 1
          fi

          echo "No large files found"
