name: Tests

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

# This workflow verifies that submodule CI passed for the specific commits referenced.
# Security checks run separately in security.yml.

jobs:
  # Verify submodule CI status for the exact commits referenced
  check-submodule-ci:
    name: Verify Submodule CI
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Get submodule commit SHAs
        id: submodules
        run: |
          echo "mesh_sha=$(git submodule status omerta_mesh | awk '{print $1}' | tr -d '+-')" >> $GITHUB_OUTPUT
          echo "node_sha=$(git submodule status omerta_node | awk '{print $1}' | tr -d '+-')" >> $GITHUB_OUTPUT
          echo "lang_sha=$(git submodule status omerta_lang | awk '{print $1}' | tr -d '+-')" >> $GITHUB_OUTPUT
          echo "protocol_sha=$(git submodule status omerta_protocol | awk '{print $1}' | tr -d '+-')" >> $GITHUB_OUTPUT

      - name: Check omerta_mesh CI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.submodules.outputs.mesh_sha }}"
          echo "Checking omerta_mesh CI for commit ${SHA:0:8}..."

          # Get workflow runs for this commit
          RESULT=$(gh api repos/mjtomei/omerta_mesh/actions/runs \
            --jq ".workflow_runs[] | select(.head_sha == \"$SHA\" and .name == \"Tests\") | {status, conclusion}" \
            2>/dev/null | head -1)

          if [ -z "$RESULT" ]; then
            echo "::warning::No CI run found for omerta_mesh commit $SHA"
            echo "This may be expected if the submodule workflow hasn't been set up yet."
          else
            STATUS=$(echo "$RESULT" | jq -r '.status')
            CONCLUSION=$(echo "$RESULT" | jq -r '.conclusion')
            echo "Status: $STATUS, Conclusion: $CONCLUSION"

            if [ "$STATUS" = "completed" ] && [ "$CONCLUSION" != "success" ]; then
              echo "::error::omerta_mesh CI failed for commit $SHA"
              exit 1
            elif [ "$STATUS" != "completed" ]; then
              echo "::warning::omerta_mesh CI still running for commit $SHA"
            fi
          fi

      - name: Check omerta_node CI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.submodules.outputs.node_sha }}"
          echo "Checking omerta_node CI for commit ${SHA:0:8}..."

          RESULT=$(gh api repos/mjtomei/omerta_node/actions/runs \
            --jq ".workflow_runs[] | select(.head_sha == \"$SHA\" and .name == \"Tests\") | {status, conclusion}" \
            2>/dev/null | head -1)

          if [ -z "$RESULT" ]; then
            echo "::warning::No CI run found for omerta_node commit $SHA"
            echo "This may be expected if the submodule workflow hasn't been set up yet."
          else
            STATUS=$(echo "$RESULT" | jq -r '.status')
            CONCLUSION=$(echo "$RESULT" | jq -r '.conclusion')
            echo "Status: $STATUS, Conclusion: $CONCLUSION"

            if [ "$STATUS" = "completed" ] && [ "$CONCLUSION" != "success" ]; then
              echo "::error::omerta_node CI failed for commit $SHA"
              exit 1
            elif [ "$STATUS" != "completed" ]; then
              echo "::warning::omerta_node CI still running for commit $SHA"
            fi
          fi

      - name: Check omerta_lang CI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.submodules.outputs.lang_sha }}"
          echo "Checking omerta_lang CI for commit ${SHA:0:8}..."

          RESULT=$(gh api repos/mjtomei/omerta_lang/actions/runs \
            --jq ".workflow_runs[] | select(.head_sha == \"$SHA\" and .name == \"Tests\") | {status, conclusion}" \
            2>/dev/null | head -1)

          if [ -z "$RESULT" ]; then
            echo "::warning::No CI run found for omerta_lang commit $SHA"
            echo "This may be expected if the submodule workflow hasn't been set up yet."
          else
            STATUS=$(echo "$RESULT" | jq -r '.status')
            CONCLUSION=$(echo "$RESULT" | jq -r '.conclusion')
            echo "Status: $STATUS, Conclusion: $CONCLUSION"

            if [ "$STATUS" = "completed" ] && [ "$CONCLUSION" != "success" ]; then
              echo "::error::omerta_lang CI failed for commit $SHA"
              exit 1
            elif [ "$STATUS" != "completed" ]; then
              echo "::warning::omerta_lang CI still running for commit $SHA"
            fi
          fi

      - name: Check omerta_protocol CI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.submodules.outputs.protocol_sha }}"
          echo "Checking omerta_protocol CI for commit ${SHA:0:8}..."

          RESULT=$(gh api repos/mjtomei/omerta_protocol/actions/runs \
            --jq ".workflow_runs[] | select(.head_sha == \"$SHA\" and .name == \"Tests\") | {status, conclusion}" \
            2>/dev/null | head -1)

          if [ -z "$RESULT" ]; then
            echo "::warning::No CI run found for omerta_protocol commit $SHA"
            echo "This may be expected if the submodule workflow hasn't been set up yet."
          else
            STATUS=$(echo "$RESULT" | jq -r '.status')
            CONCLUSION=$(echo "$RESULT" | jq -r '.conclusion')
            echo "Status: $STATUS, Conclusion: $CONCLUSION"

            if [ "$STATUS" = "completed" ] && [ "$CONCLUSION" != "success" ]; then
              echo "::error::omerta_protocol CI failed for commit $SHA"
              exit 1
            elif [ "$STATUS" != "completed" ]; then
              echo "::warning::omerta_protocol CI still running for commit $SHA"
            fi
          fi
