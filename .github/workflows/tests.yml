name: Tests

on:
  push:
    branches: [master]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - 'LICENSE'
      - 'licenses/**'
      - 'plans/**'
      - '.gitignore'
  pull_request:
    branches: [master]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - 'LICENSE'
      - 'licenses/**'
      - 'plans/**'
      - '.gitignore'

# This workflow verifies that submodule CI passed for the specific commits referenced.
# Security checks run separately in security.yml.

jobs:
  # Verify submodule CI status for the exact commits referenced
  check-submodule-ci:
    name: Verify Submodule CI
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Get submodule commit SHAs
        id: submodules
        run: |
          echo "mesh_sha=$(git submodule status omerta_mesh | awk '{print $1}' | tr -d '+-')" >> $GITHUB_OUTPUT
          echo "node_sha=$(git submodule status omerta_node | awk '{print $1}' | tr -d '+-')" >> $GITHUB_OUTPUT
          echo "lang_sha=$(git submodule status omerta_lang | awk '{print $1}' | tr -d '+-')" >> $GITHUB_OUTPUT
          echo "protocol_sha=$(git submodule status omerta_protocol | awk '{print $1}' | tr -d '+-')" >> $GITHUB_OUTPUT

      - name: Wait for omerta_mesh CI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.submodules.outputs.mesh_sha }}"
          echo "Waiting for omerta_mesh CI for commit ${SHA:0:8}..."

          MAX_ATTEMPTS=60  # 10 minutes max (60 * 10 seconds)
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESULT=$(gh api repos/mjtomei/omerta_mesh/actions/runs \
              --jq ".workflow_runs[] | select(.head_sha == \"$SHA\" and .name == \"Tests\") | {status, conclusion}" \
              2>/dev/null | head -1)

            if [ -z "$RESULT" ]; then
              echo "No CI run found yet for commit $SHA (attempt $((ATTEMPT+1))/$MAX_ATTEMPTS)"
              sleep 10
              ATTEMPT=$((ATTEMPT+1))
              continue
            fi

            STATUS=$(echo "$RESULT" | jq -r '.status')
            CONCLUSION=$(echo "$RESULT" | jq -r '.conclusion')

            if [ "$STATUS" = "completed" ]; then
              echo "CI completed with conclusion: $CONCLUSION"
              if [ "$CONCLUSION" != "success" ]; then
                echo "::error::omerta_mesh CI failed for commit $SHA"
                exit 1
              fi
              echo "omerta_mesh CI passed!"
              exit 0
            fi

            echo "CI still running (attempt $((ATTEMPT+1))/$MAX_ATTEMPTS)..."
            sleep 10
            ATTEMPT=$((ATTEMPT+1))
          done

          echo "::error::Timeout waiting for omerta_mesh CI to complete"
          exit 1

      - name: Wait for omerta_node CI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.submodules.outputs.node_sha }}"
          echo "Waiting for omerta_node CI for commit ${SHA:0:8}..."

          MAX_ATTEMPTS=60
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESULT=$(gh api repos/mjtomei/omerta_node/actions/runs \
              --jq ".workflow_runs[] | select(.head_sha == \"$SHA\" and .name == \"Tests\") | {status, conclusion}" \
              2>/dev/null | head -1)

            if [ -z "$RESULT" ]; then
              echo "No CI run found yet for commit $SHA (attempt $((ATTEMPT+1))/$MAX_ATTEMPTS)"
              sleep 10
              ATTEMPT=$((ATTEMPT+1))
              continue
            fi

            STATUS=$(echo "$RESULT" | jq -r '.status')
            CONCLUSION=$(echo "$RESULT" | jq -r '.conclusion')

            if [ "$STATUS" = "completed" ]; then
              echo "CI completed with conclusion: $CONCLUSION"
              if [ "$CONCLUSION" != "success" ]; then
                echo "::error::omerta_node CI failed for commit $SHA"
                exit 1
              fi
              echo "omerta_node CI passed!"
              exit 0
            fi

            echo "CI still running (attempt $((ATTEMPT+1))/$MAX_ATTEMPTS)..."
            sleep 10
            ATTEMPT=$((ATTEMPT+1))
          done

          echo "::error::Timeout waiting for omerta_node CI to complete"
          exit 1

      - name: Wait for omerta_lang CI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.submodules.outputs.lang_sha }}"
          echo "Waiting for omerta_lang CI for commit ${SHA:0:8}..."

          MAX_ATTEMPTS=60
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESULT=$(gh api repos/mjtomei/omerta_lang/actions/runs \
              --jq ".workflow_runs[] | select(.head_sha == \"$SHA\" and .name == \"Tests\") | {status, conclusion}" \
              2>/dev/null | head -1)

            if [ -z "$RESULT" ]; then
              echo "No CI run found yet for commit $SHA (attempt $((ATTEMPT+1))/$MAX_ATTEMPTS)"
              sleep 10
              ATTEMPT=$((ATTEMPT+1))
              continue
            fi

            STATUS=$(echo "$RESULT" | jq -r '.status')
            CONCLUSION=$(echo "$RESULT" | jq -r '.conclusion')

            if [ "$STATUS" = "completed" ]; then
              echo "CI completed with conclusion: $CONCLUSION"
              if [ "$CONCLUSION" != "success" ]; then
                echo "::error::omerta_lang CI failed for commit $SHA"
                exit 1
              fi
              echo "omerta_lang CI passed!"
              exit 0
            fi

            echo "CI still running (attempt $((ATTEMPT+1))/$MAX_ATTEMPTS)..."
            sleep 10
            ATTEMPT=$((ATTEMPT+1))
          done

          echo "::error::Timeout waiting for omerta_lang CI to complete"
          exit 1

      - name: Wait for omerta_protocol CI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.submodules.outputs.protocol_sha }}"
          echo "Waiting for omerta_protocol CI for commit ${SHA:0:8}..."

          MAX_ATTEMPTS=60
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESULT=$(gh api repos/mjtomei/omerta_protocol/actions/runs \
              --jq ".workflow_runs[] | select(.head_sha == \"$SHA\" and .name == \"Tests\") | {status, conclusion}" \
              2>/dev/null | head -1)

            if [ -z "$RESULT" ]; then
              echo "No CI run found yet for commit $SHA (attempt $((ATTEMPT+1))/$MAX_ATTEMPTS)"
              sleep 10
              ATTEMPT=$((ATTEMPT+1))
              continue
            fi

            STATUS=$(echo "$RESULT" | jq -r '.status')
            CONCLUSION=$(echo "$RESULT" | jq -r '.conclusion')

            if [ "$STATUS" = "completed" ]; then
              echo "CI completed with conclusion: $CONCLUSION"
              if [ "$CONCLUSION" != "success" ]; then
                echo "::error::omerta_protocol CI failed for commit $SHA"
                exit 1
              fi
              echo "omerta_protocol CI passed!"
              exit 0
            fi

            echo "CI still running (attempt $((ATTEMPT+1))/$MAX_ATTEMPTS)..."
            sleep 10
            ATTEMPT=$((ATTEMPT+1))
          done

          echo "::error::Timeout waiting for omerta_protocol CI to complete"
          exit 1
