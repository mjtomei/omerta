name: Security Checks

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  hook-tests:
    name: Git Hook Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Checkout public submodules
        run: |
          git submodule update --init --depth=1 omerta_lang omerta_protocol omerta_node omerta_mesh

      - name: Ensure hooks are executable
        run: |
          chmod +x .githooks/* 2>/dev/null || true
          for dir in omerta_lang omerta_mesh omerta_node omerta_protocol; do
            [ -d "$dir/.githooks" ] && chmod +x "$dir/.githooks/"* 2>/dev/null || true
          done

      - name: Test hook functionality
        run: ./scripts/test-hooks.sh

  hooks-sync:
    name: Hooks Sync Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Checkout public submodules
        run: |
          git submodule update --init --depth=1 omerta_lang omerta_protocol omerta_node omerta_mesh

      - name: Verify hooks are in sync
        run: ./scripts/check-hooks-sync.sh

  sensitive-data:
    name: Sensitive Data Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout public submodules
        run: |
          git submodule update --init --depth=1 omerta_lang omerta_protocol omerta_node omerta_mesh

      - name: Check for sensitive patterns
        run: |
          # Patterns that indicate sensitive data (full PEM headers, not partial matches)
          PATTERNS=(
            '-----BEGIN RSA PRIVATE KEY-----'
            '-----BEGIN DSA PRIVATE KEY-----'
            '-----BEGIN EC PRIVATE KEY-----'
            '-----BEGIN OPENSSH PRIVATE KEY-----'
            '-----BEGIN PGP PRIVATE KEY-----'
            'AWS_ACCESS_KEY_ID\s*='
            'AWS_SECRET_ACCESS_KEY\s*='
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            # Exclude test directories and .git
            if grep -rniE "$pattern" \
                --include="*.swift" --include="*.py" --include="*.json" \
                --include="*.yaml" --include="*.yml" --include="*.toml" \
                . 2>/dev/null | grep -vE '\.git|\.venv|__pycache__|node_modules|/[Tt]ests?/'; then
              echo "::error::Pattern '$pattern' found in repository"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "::error::Potential sensitive data found"
            exit 1
          fi

          echo "No sensitive data patterns found"

  large-files:
    name: Large File Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Checkout public submodules
        run: |
          git submodule update --init --depth=1 omerta_lang omerta_protocol omerta_node omerta_mesh

      - name: Check for large files
        run: |
          # Find files larger than 1MB (excluding compiled libraries)
          LARGE_FILES=$(find . -type f -size +1M \
            -not -path "./.git/*" \
            -not -path "./.venv/*" \
            -not -path "./.build/*" \
            -not -path "./node_modules/*" \
            -not -name "*.a" \
            -not -name "*.o" \
            -not -name "*.so" \
            -not -name "*.dylib" 2>/dev/null)

          if [ -n "$LARGE_FILES" ]; then
            echo "::error::Large files (>1MB) found:"
            echo "$LARGE_FILES"
            exit 1
          fi

          echo "No large files found"

  key-files:
    name: Key File Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Checkout public submodules
        run: |
          git submodule update --init --depth=1 omerta_lang omerta_protocol omerta_node omerta_mesh

      - name: Check for key files
        run: |
          # Check for private key file extensions
          KEY_FILES=$(find . -type f \( \
            -name "*.pem" -o \
            -name "*.key" -o \
            -name "*.p12" -o \
            -name "*.pfx" -o \
            -name "id_rsa" -o \
            -name "id_dsa" -o \
            -name "id_ecdsa" -o \
            -name "id_ed25519" \
            \) -not -path "./.git/*" 2>/dev/null)

          if [ -n "$KEY_FILES" ]; then
            echo "::error::Private key files found:"
            echo "$KEY_FILES"
            exit 1
          fi

          echo "No private key files found"
