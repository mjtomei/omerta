name: Update Commit Hash

# Triggered by sub-repo CI on push to master.
# This is the only workflow allowed to push directly to master.
# Configure a branch protection ruleset on master that:
#   - Requires PRs for all pushes
#   - Adds a bypass for the GitHub App or PAT used by PUSH_TOKEN

on:
  repository_dispatch:
    types: [subrepo-updated]

# Serialize so concurrent dispatches queue instead of racing
concurrency:
  group: update-commit
  cancel-in-progress: false

jobs:
  update-commits:
    name: Update all .commit files
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PUSH_TOKEN }}

      - name: Update all .commit files
        run: |
          MODULES="omerta_node omerta_mesh omerta_lang omerta_protocol omerta_infra"
          changed=0

          for mod in $MODULES; do
            remote_sha=$(git ls-remote "https://github.com/mjtomei/$mod" refs/heads/master | cut -f1)
            if [ -z "$remote_sha" ]; then
              echo "WARNING: could not resolve master for $mod"
              continue
            fi

            current_sha=$(cat "$mod/.commit" 2>/dev/null | tr -d '[:space:]')
            if [ "$remote_sha" != "$current_sha" ]; then
              echo "$remote_sha" > "$mod/.commit"
              git add -f "$mod/.commit"
              echo "Updated $mod: ${current_sha:0:8} -> ${remote_sha:0:8}"
              changed=1
            else
              echo "$mod is up to date (${current_sha:0:8})"
            fi
          done

          if [ $changed -eq 1 ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git commit -m "Update .commit hashes to latest master"
            git push origin master
          else
            echo "All .commit files are current"
          fi
